<!DOCTYPE html>
<html>

    <head>
        <title>
            Sign-up Page
        </title>
        <link rel="stylesheet" type="text/css" href="signup.css">
    </head>

    <body>
        <h2>Create an Account</h2>

        <form id = "signup-form">

            <label>Username:</label><br>
            <input type = "text" id = "userName" required><br>

            <label>Email:</label><br>
            <input type = "email" id = "email" required><br>

            <label>Password:</label><br>
            <input type = "password" id = "passWord" required><br>

            <label>Confirm Password:</label><br>
            <input type = "password" id = "confirmPass" required><br><br>

            <button type="submit">Sign-up</button>

        </form>

        <script>

            const getUsersArray = () => {
                const usersJSON = localStorage.getItem('registeredUsers');
                if (!usersJSON) return [];
                
                try {
                    const storedData = JSON.parse(usersJSON);
                    if (Array.isArray(storedData)) {
                        return storedData; 
                    } else if (typeof storedData === 'object' && storedData !== null) {
                        return Object.values(storedData); 
                    }
                } catch (e) {
                    console.error("Error retrieving user data:", e);
                }
                return []; // Fallback
            };

            function nextStep(){

                event.preventDefault();

                var username = document.getElementById("userName").value.trim();
                var email = document.getElementById("email").value.trim();
                var password = document.getElementById("passWord").value;
                var confirmPass = document.getElementById("confirmPass").value;
                
                //validation
                if (!document.getElementById("signup-form").checkValidity()) return;

                var userPattern = /^[a-zA-Z][a-zA-Z0-9_]{2,15}$/;
                var passPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@.#$!%*?&])[A-Za-z\d@.#$!%*?&]{8,15}$/;
                var emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

                if(!userPattern.test(username)){
                    alert("⚠ Username: Must start with a letter, 3-16 chars, only letters, numbers, or underscores.");
                    return;
                }

                if(!passPattern.test(password)){
                    alert("⚠ Password: Must contain 8-15 chars, including 1 upper, 1 lower, 1 digit, and 1 special symbol.");
                    return;
                }

                if(!emailPattern.test(email)){
                    alert("⚠ Please enter a valid email address (e.g, abc@efg.com).")
                    return;
                }

                if(confirmPass !== password){
                    alert("⚠ Password does not match")
                    return;
                }

                // 3. Uniqueness Check 
                let usersArray = getUsersArray();

                const exists = usersArray.some(user => 
                    user.username === username || user.email === email
                );

                if (exists) {
                    alert("⚠ Error: An account with this email or username already exists.");
                    return;
                }

                // 4. Store New User
                const userData = {
                    username: username,
                    email: email,
                    password: password,
                    registrationDate: new Date().toLocaleString()
                    };

                // Add the new user to the array
                usersArray.push(userData);

                // Save the updated array
                localStorage.setItem('registeredUsers', JSON.stringify(usersArray));

                // Save the latest user to quickly access details on the next page
                localStorage.setItem('latestUser', JSON.stringify(userData));

                alert(`✅ Sign-up Successful! Welcome, ${username}. You will now proceed to complete your profile.`);

                window.location.href = 'registration.html'
            }

            // Attach the submit listener to the form
            document.getElementById('signup-form').addEventListener('submit', nextStep);
        </script>

    </body>

</html>