<!DOCTYPE html>
<html lang = "en">
    <head>
        <meta charset = "utf-8" />
        <title>JSON</title>
        <link rel = 'stylesheet' href = 'styles.css'>
    </head>

    <body>
        <div id="app-container">
        <header id="main-header"><h1>Event Management System</h1></header>
        <main>
            <section id="event-form-section" class="data-input-area">
                <form id = 'recordForm'>
                    <label>Event Name:<br><input type = 'text' id = 'event_name'></label><br>
                    <label>Event Type:<br><input type = 'text' id = 'event_type'></label><br>
                    <label for = 'event_date'>Select an event date:</label><br>
                    <input type = 'date' id = 'event_date' name = 'event_date'><br>
                    <label for = 'event_time'>Time:</label><br>
                    <input type= 'time' id = 'event_time' name = 'event_time'><br>
                    <label>Venue:<br><input type = 'text' id = 'event_venue'></label><br>
                    <button type = 'submit' id = 'saveBtn'>Save</button>
                </form>
            </section>

        <hr>
        <section id="saved-records-section" class="data-display-area"></section>
            <h2>Saved Records</h2>
            <div id="table-container">
                <table border = '1' id = 'recordsTable' class = 'event-table'>
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Event Type</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Venue</th>
                            <th>Action</th>
                        
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </section>
    </main>
        <script>
            //The storage key we will use in localStorage const DB_KEY = 'event_db_v1';
            const DB_KEY = 'event_db_v1'
            //Seed data: used when no DB exists yet
            const seedData = [
                {event_name: 'Hackathons', event_type: 'Academic', event_date: '2025-06-01', event_time: '9:00', event_venue: 'Aula Minor'},
                {event_name: 'Basketball Competition', event_type: 'Extracurricular', event_date: '2025-08-10', event_time: '11:00', event_venue: 'PCC Gym'},
                {event_name: 'Talent Show', event_type: 'Extracurricular', event_date: '2025-12-18', event_time: '12:00', event_venue: 'PCC Grounds'},
                {event_name: 'Exhibit', event_type: 'Academic', event_date: '2026-02-21', event_time: '8:00', event_venue: 'Room 401'}
            ];

            //load the DB later
            let db = [];
            let editIndex = -1
            var form = document.getElementById('recordForm');
            var saveButton = document.getElementById('saveBtn');

            // DOM element references
            var inputEventName = document.getElementById('event_name');
            var inputEventType = document.getElementById('event_type');
            var inputEventDate = document.getElementById('event_date');
            var inputEventTime = document.getElementById('event_time');
            var inputEventVenue = document.getElementById('event_venue');

            //Load DB
            function loadDB(){
                const raw = localStorage.getItem(DB_KEY);
                if (raw){
                    try{
                        db = JSON.parse(raw);
                    }catch(e){
                        console.error('Failed to parse DB from localStorage, resetting to seed:', e);
                        db = [...seedData];
                        saveDB();
                    }
                }else{
                    db = [...seedData];
                    saveDB();
                }
            }
            
            //Save DB to localStorage
            function saveDB(){
                localStorage.setItem(DB_KEY,JSON.stringify(db));
            }

            //Display Table
            function displayRecord(){
                const tbody = document.getElementById('recordsTable').querySelector('tbody');
                
                // Clear old rows
                tbody.innerHTML = ''; 

                db.forEach((r, index) => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = r.event_name;
                    row.insertCell().textContent = r.event_type;
                    row.insertCell().textContent = r.event_date;
                    row.insertCell().textContent = r.event_time;
                    row.insertCell().textContent = r.event_venue;
                    
                    const actionCell = row.insertCell();
                    // Use index for reliable editing/deleting, not event_name
                    actionCell.innerHTML = `
                        <button type="button" onclick="editRecord(${index})">Edit</button>
                        <button type="button" onclick="deleteRecord(${index})">Delete</button>
                    `;
                });
            }
            
            //Immediately load DB on page load
            loadDB();

            function saveRecord(){

                event.preventDefault(); // Stop form submission/page reload

                // Input validation check

                if (!form.checkValidity()) {
                    alert('Please fill out all required fields.');
                    return;
                }

                //Read inputs
                const event_name = document.getElementById('event_name').value;
                const event_type = document.getElementById('event_type').value;
                const event_date = document.getElementById('event_date').value;
                const event_time = document.getElementById('event_time').value;
                const event_venue = document.getElementById('event_venue').value;
                //Create record object
                const newRecord = {event_name, event_type, event_date, event_time, event_venue};
                //Add or edit record to array
                if(editIndex === -1){
                    if (db.some(r => r.event_name === event_name)) {
                        alert('Error: An event with this name already exists.');
                        return;
                    }
                    db.push(newRecord);
                    alert('Record saved successfully!');
                }else{
                    if (db.some((r, i) => r.event_name === event_name && i !== editIndex)) {
                        alert('Error: An event with this name already exists.');
                        return;
                    }
                    db[editIndex] = newRecord;
                    editIndex = -1;
                    saveButton.textContent = 'Save';
                    alert('Record edit successfully!');
                }
                //Save to localStorage
                saveDB();
                displayRecord();
                console.log('Record saved', newRecord);
                //Clear form fields
                document.getElementById('recordForm').reset();
            }
            //Edit Record
            function editRecord(index){
                var record = db[index];
                if(!record) return;

                // Populate the form fields using their DOM element references

                inputEventName.value = record.event_name;
                inputEventType.value = record.event_type;
                inputEventDate.value = record.event_date;
                inputEventTime.value = record.event_time;
                inputEventVenue.value = record.event_venue;
                
                // Set the global editIndex and update button text
                editIndex = index;
                saveButton.textContent = 'Update';

                inputEventName.focus();
            }
            //Delete Record
            function deleteRecord(index){
                const recordToDelete = db[index];
                if(!recordToDelete) return;
                //Confirm first
                const ok = confirm(`Delete event: ${recordToDelete.event_name}?`);
                if(!ok)return;
                //Find Index
               db.splice(index, 1);
                saveDB();
                displayRecord();
                alert('Record deleted successfully.');
            //Remove and Save
            db.splice(index, 1);
            saveDB();
            displayRecord();
            }
            
            loadDB();
            displayRecord();

            // Attach saveRecord to the form submit event
            form.addEventListener('submit', saveRecord);
        </script>
    </body>
</html>