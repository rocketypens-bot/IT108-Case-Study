<!DOCTYPE html>
<html>
    <head>
        <title>

        </title>
    </head>

    <body>
        <form id = 'registration'>
            
            <label>First Name:</label><br>
            <input type = "text" id = "fname" required><br>

            <label>Last Name:</label><br>
            <input type = "text" id = "lname" required><br>

            <label>Middle Name:</label><br>
            <input type = "text" id = "mname" required><br>
            
            <label>Age:</label><br>
            <input type = "number" id = "age" min = "1" value = "1" required><br>

            <label>Gender:</label><br>
            <select id = "gender" required>
                <option value = "Male">Male</option>
                <option value = "Female">Female</option>
                <option value = "Non-binary">Non-binary</option>
                <option value = "preferG">Prefer not to say</option>
            </select><br>

            <label>Civil Status:</label><br>
            <select id = "cStatus" required>
                <option value = "Single">Single</option>
                <option value = "Married">Married</option>
                <option value = "preferC">Prefer not to say</option>
            </select><br>

            <label>Address:</label><br>
            <input type = "text" id = "address" required><br><br>

            <label>Contact Number:</label><br>
            <input type = "text" id = "contact" placeholder= "e.g 09123456789" required><br>

            <button type="submit">Review & Continue</button>

        </form>

        <script>

            const getUsersArray = () => {
                const usersJSON = localStorage.getItem('registeredUsers');
                if (!usersJSON) return [];
                try {
                    const storedData = JSON.parse(usersJSON);
                    if (Array.isArray(storedData)) return storedData;
                    if (typeof storedData === 'object' && storedData !== null) return Object.values(storedData);
                } catch (e) {
                    console.error("Error retrieving user data:", e);
                }
                return [];
            };

            function processRegistration(){

                event.preventDefault(); 
                var form = document.getElementById('registration');

                if (!form.checkValidity()) {
                    return; 
                }

                // 1. Get Login Data & All Users

                const latestUserJSON = localStorage.getItem('latestUser');
                if (!latestUserJSON) {
                    alert("Fatal Error: Could not find account data. Please sign up again.");
                    window.location.href = 'signup.html';
                    return;
                }

                const latestUserData = JSON.parse(latestUserJSON);
                var usersArray = getUsersArray();

               // 2. Gather Personal Details
                var fname = document.getElementById("fname").value.trim();
                var lname = document.getElementById("lname").value.trim();
                var mname = document.getElementById("mname").value.trim();
                var age = Number(document.getElementById("age").value);
                var gender = document.getElementById("gender").value;
                var cStatus = document.getElementById("cStatus").value;
                var address = document.getElementById("address").value.trim();
                var contact = document.getElementById("contact").value.trim();

                //validation

                var namePattern = /^[A-Za-z\s]+$/;
                var phonePattern = /^09\d{9}$/;
                var emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

                 if(!namePattern.test(lname)){
                    alert("⚠ Please enter a valid name (letters and spaces only).");
                    return;
                }

                 if(!namePattern.test(fname)){
                    alert("⚠ Please enter a valid name (letters and spaces only).");
                    return;
                }

                 if(!namePattern.test(mname)){
                    alert("⚠ Please enter a valid name (letters and spaces only).");
                    return;
                }
                if(!phonePattern.test(contact)){
                    alert("⚠ Please enter a valid contact number (e.g., 09123456789).");
                    return;
                }
                if(age < 1){
                    alert("⚠ Please enter a valid age")
                }
                if(address === ""){
                    alert("⚠ Please enter your address")
                }
            
            var completeUser = {
                ...latestUserData,
                firstName: fname,
                lastName: lname,
                middleName: mname,
                age: age,
                gender: gender,
                civilStatus: cStatus,
                address: address,
                contactNumber: contact,
                profileCompletionDate: new Date().toLocaleString()
            };

           const userIndex = usersArray.findIndex(
                user => user.username === completeUser.username
            );

            if (userIndex !== -1) {
                usersArray[userIndex] = completeUser;
                localStorage.setItem('registeredUsers', JSON.stringify(usersArray));
                localStorage.setItem('latestUser', JSON.stringify(completeUser));
                
                alert("Profile details saved! Proceeding to confirmation.");
                window.location.href = 'confirmation.html';
                } else {
                    alert('⚠ ErrorL Could not find your account to update. Please try signing up again.')
                }
            
            }

            document.getElementById('registration').addEventListener('submit', processRegistration);
        </script>
    </body>
</html>